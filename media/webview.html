<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="table.css">
</head>
<body>
  <div id="table-container">
    <table id="tsv-table">
      <!-- Table will be generated by JavaScript -->
    </table>
  </div>
  
  <!-- Context Menu -->
  <div id="context-menu" class="context-menu" style="display: none;">
    <div class="menu-item" onclick="insertRowBefore()">Insert Row Before</div>
    <div class="menu-separator"></div>
    <div class="menu-item" onclick="deleteRow()">Delete Row</div>
  </div>
  
  <script>
    const vscode = acquireVsCodeApi();
    
    // Handle individual cell edit
    function handleCellEdit(event) {
      const input = event.target;
      const row = parseInt(input.dataset.row);
      const col = parseInt(input.dataset.col);
      
      // Send cell edit to provider
      vscode.postMessage({ 
        type: 'cellEdit', 
        data: {
          position: { row, col },
          value: input.value
        }
      });
    }
    
    // Handle keyboard navigation
    function handleKeyNavigation(event) {
      const input = event.target;
      const row = parseInt(input.dataset.row);
      const col = parseInt(input.dataset.col);
      
      let targetRow = row;
      let targetCol = col;
      let preventDefault = false;
      
      switch(event.key) {
        case 'Tab':
          if (event.shiftKey) {
            // Shift+Tab: move left
            targetCol = col - 1;
          } else {
            // Tab: move right
            targetCol = col + 1;
          }
          preventDefault = true;
          break;
          
        case 'ArrowUp':
          targetRow = row - 1;
          preventDefault = true;
          break;
          
        case 'ArrowDown':
          targetRow = row + 1;
          preventDefault = true;
          break;
          
        case 'ArrowLeft':
          // Only navigate if cursor is at start of input
          if (input.selectionStart === 0) {
            targetCol = col - 1;
            preventDefault = true;
          }
          break;
          
        case 'ArrowRight':
          // Only navigate if cursor is at end of input
          if (input.selectionStart === input.value.length) {
            targetCol = col + 1;
            preventDefault = true;
          }
          break;
      }
      
      if (preventDefault) {
        event.preventDefault();
        
        // Find target cell and focus it
        const targetInput = document.querySelector(`[data-row="${targetRow}"][data-col="${targetCol}"]`);
        if (targetInput) {
          targetInput.focus();
          targetInput.select(); // Select all text in the target cell
        }
      }
    }
    
    // Context menu and row operations
    let contextMenuRow = -1;
    
    // Show context menu on right click
    function showContextMenu(event, rowIndex) {
      event.preventDefault();
      contextMenuRow = rowIndex;
      const menu = document.getElementById('context-menu');
      menu.style.display = 'block';
      menu.style.left = event.pageX + 'px';
      menu.style.top = event.pageY + 'px';
    }
    
    // Hide context menu
    function hideContextMenu() {
      document.getElementById('context-menu').style.display = 'none';
    }
    
    // Row operation functions
    function insertRowBefore() {
      vscode.postMessage({
        type: 'insertRow',
        data: { rowIndex: contextMenuRow, position: 'before' }
      });
      hideContextMenu();
    }
    
    function insertRowAfter() {
      vscode.postMessage({
        type: 'insertRow',
        data: { rowIndex: contextMenuRow, position: 'after' }
      });
      hideContextMenu();
    }
    
    function deleteRow() {
      vscode.postMessage({
        type: 'deleteRow',
        data: { rowIndex: contextMenuRow }
      });
      hideContextMenu();
    }
    
    // Enhanced table rendering with context menu support
    function renderTable(tableData, dimensions) {
      const table = document.getElementById('tsv-table');
      table.innerHTML = '';
      
      tableData.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        
        // Add right-click context menu to row
        tr.addEventListener('contextmenu', (event) => showContextMenu(event, rowIndex));
        
        row.forEach((cellValue, colIndex) => {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'cell-input';
          input.value = cellValue || '';
          input.dataset.row = rowIndex;
          input.dataset.col = colIndex;
          
          // Handle cell edits
          input.addEventListener('input', handleCellEdit);
          
          // Handle keyboard navigation and shortcuts
          input.addEventListener('keydown', (event) => {
            // Enter key: Insert row after current row
            if (event.key === 'Enter') {
              vscode.postMessage({
                type: 'insertRow',
                data: { rowIndex: rowIndex, position: 'after' }
              });
              event.preventDefault();
              return;
            }
            
            // Ctrl+Delete: Delete row
            if (event.ctrlKey && event.key === 'Delete') {
              vscode.postMessage({
                type: 'deleteRow',
                data: { rowIndex: rowIndex }
              });
              event.preventDefault();
              return;
            }
            
            // Regular navigation for other keys
            handleKeyNavigation(event);
          });
          
          td.appendChild(input);
          tr.appendChild(td);
        });
        
        table.appendChild(tr);
      });
    }
    
    // Hide context menu when clicking elsewhere
    document.addEventListener('click', hideContextMenu);
    
    // Listen for messages from provider
    window.addEventListener('message', event => {
      if (event.data.type === 'init') {
        const { table, dimensions } = event.data.data;
        renderTable(table, dimensions);
      }
    });
  </script>
</body>
</html>
